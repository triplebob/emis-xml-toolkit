name: Keep Streamlit Awake

on:
  schedule:
    - cron: "0 * * * *"   # run at minute 0 every hour
  workflow_dispatch:

permissions:
  contents: read

jobs:
  ping:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Playwright
        run: |
          npm init -y
          npm install playwright
          npx playwright install chromium

      - name: Visit Streamlit App
        run: |
          node - <<'EOF'
          const { chromium } = require('playwright');

          async function visit() {
            const browser = await chromium.launch({ headless: true });
            const page = await browser.newPage();

            await page.goto("https://clinxml.streamlit.app/", {
              waitUntil: "networkidle"
            });

            // Keep the websocket alive
            await page.waitForTimeout(8000);

            await browser.close();
          }

          // Retry up to 3 times in case Streamlit is cold-starting
          (async () => {
            for (let i = 0; i < 3; i++) {
              try {
                await visit();
                console.log("Ping successful");
                return;
              } catch (err) {
                console.log("Attempt failed:", err.message);
                if (i === 2) throw err;
                await new Promise(r => setTimeout(r, 5000));
              }
            }
          })();
          EOF
